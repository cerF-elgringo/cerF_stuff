<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>GLABDLE</title>
<link href="https://fonts.cdnfonts.com/css/grobold" rel="stylesheet">
<style>
/* Mobile consistency fixes */
* {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    text-size-adjust: 100%;
    -webkit-text-size-adjust: 100%;
    -moz-text-size-adjust: 100%;
}

html {
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
    font-size: 16px; /* Base font size */
}

body {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    touch-action: manipulation;
}
/* (CSS unchanged from previous working file) */
html, body { -ms-overflow-style: none; scrollbar-width: none; overflow: hidden }
html::-webkit-scrollbar, body::-webkit-scrollbar { display:none; width:0; height:0; }
*{box-sizing:border-box;margin:0;padding:0}
html,body{min-height:100%;height:100%;width:100%;overflow-x:hidden;overflow-y:hidden;font-family:'GROBOLD',sans-serif;display:flex;justify-content:center;align-items:center;padding:28px;background-color:black;color:#206cd2;background-image:url('https://hosky.io/_next/image?url=%2F_next%2Fstatic%2Fmedia%2FHosky_1200.9361cc3f.png&w=3840&q=85&dpl=dpl_A35He1TJdeTQghKRghvecRxzGvvJ');background-repeat:repeat;background-size:150px auto}
#game-wrapper{display:none;flex-direction:column;align-items:center;background-color:rgba(0,0,0,0.5);min-width:340px;max-width:90vw;padding:20px;border-radius:10px;max-height:none;overflow:visible;-webkit-overflow-scrolling:auto; overflow: hidden}
h1{font-size:72px;margin-bottom:20px;color:#206cd2;text-shadow:0 0 5px #00ff00,0 0 8px #00ff00,0 0 8px #00ff00}
#game-container{display:grid;grid-template-rows:repeat(6,auto);grid-gap:10px;margin-bottom:20px;width:100%;overflow:visible}
.row{display:grid;grid-gap:10px;justify-content:center}
.cell{width:63px;height:63px;border:2px solid #206cd2;display:flex;justify-content:center;align-items:center;font-size:36px;text-transform:uppercase;color:#206cd2;background-color:black;user-select:none;border-radius:6px}
.cell.active{border-color:#ffc107;box-shadow:0 0 10px #ffc107}
.green{background-color:#206cd2;color:black}
.yellow{background-color:#ffc107;color:black}
.gray{background-color:#555;color:black}
.cell.locked{pointer-events:none;opacity:0.6;user-select:none}
#alphabet{display:flex;flex-wrap:wrap;max-width:420px;justify-content:center;gap:5px;margin-top:5px}
.letter-box{width:45px;height:45px;border:3.5px solid #206cd2;display:flex;justify-content:center;align-items:center;text-transform:uppercase;color:#206cd2;font-size:18px;user-select:none;border-radius:6px;background-color:rgba(0,0,0,0.9)}
.letter-box:hover{background-color:#206cd2;color:black;transform:scale(1.1);box-shadow:0 0 8px #206cd2}
.quantum-small-btn {
    margin-top: 10px;
    font-size: 20px !important;   /* smaller text */
    padding: 8px 18px !important;  /* smaller button */
    min-width: 200px !important;   /* narrower */
    display: block;
    margin-left: auto;
    margin-right: auto;            /* centers it */
}
#letter-enter{margin-right:12px}#letter-backspace{margin-left:12px}
@media(max-width:500px), (max-width: 500px) {
    html, body {
        padding: 8px;
    }
    
    h1 {
        font-size: clamp(36px, 10vw, 56px);
        margin-bottom: 12px;
    }
    
    #game-wrapper {
        padding: 12px;
        min-width: 300px;
    }
    
    .cell {
        font-size: clamp(18px, 5vw, 36px);
    }
    
    .letter-box {
        font-size: clamp(14px, 3.5vw, 18px);
    }
    
    #letter-enter, #letter-backspace {
        width: 80px;
	height: 45px;
        font-size: 14px;
    }
    
    #letter-enter {
        margin-right: 4px;
    }
    
    #letter-backspace {
        margin-left: 4px;
    }
}
#letter-enter,
#letter-backspace {
    width: 80px;        /* can stay longer than normal keys */
    height: 45px;       /* MATCH the .letter-box height */
    border-radius: 6px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    font-weight: bold;
    transition: all .2s ease;
}


#letter-enter{background-color:#00ff00;color:black}
#letter-enter:hover{background-color:#0000ff;transform:scale(1.05)}
#letter-backspace{background-color:black;border:3.5px solid #206cd2;color:#206cd2}
#letter-backspace:hover{background-color:#206cd2;color:black;transform:scale(1.05);box-shadow:0 0 8px #206cd2}
@media(max-width:500px){#letter-enter,#letter-backspace{width:80px; height: 45px}}
#mobile-input{position:absolute;opacity:0;width:1px;height:1px}
#win-gif-container,#lose-gif-container{display:none;opacity:0;transition:opacity 1s ease;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;width:450px;max-width:90%}
#win-message,#lose-message{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) rotate(0deg);font-size:84px;line-height:1.1;text-align:center;z-index:9998;background:linear-gradient(90deg,red,orange,yellow,green,blue,indigo,violet);background-size:300% 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 6px #ff69b4) drop-shadow(0 0 12px #ff69b4);animation:gradientMove .8s linear infinite alternate,wiggle .2s ease-in-out infinite alternate;overflow:visible}
@keyframes gradientMove{0%{background-position:0% 50%}50%{background-position:150% 50%}100%{background-position:300% 50%}}
@keyframes revealLetter{0%{transform:scale(0.9);opacity:.7}50%{transform:scale(1.2);opacity:1}100%{transform:scale(1);opacity:1}}
@keyframes wiggle{0%{transform:translate(-50%,-50%) rotate(-2deg)}50%{transform:translate(-50%,-50%) rotate(2deg)}100%{transform:translate(-50%,-50%) rotate(-2deg)}}
.falling-poo{position:absolute;pointer-events:none;user-select:none;animation-name:fall;animation-timing-function:linear}
@keyframes fall{0%{transform:translateY(-200px) rotate(0deg)}100%{transform:translateY(100vh) rotate(720deg)}}
#games-counter{display:none!important}
#mode-select-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);z-index:100000;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:20px}
.mode-btn{font-family:'GROBOLD',sans-serif;font-size:32px;color:#206cd2;background:black;border:2px solid #206cd2;padding:15px 30px;cursor:pointer;text-transform:uppercase;border-radius:8px;transition:.3s}
.mode-btn:hover{box-shadow:0 0 15px #ff9900;color:#ffc107;border-color:#ffc107}
.mode-title{font-size:48px;color:#cccccc;text-shadow:0 0 2px #888,0 0 6px #666}
@media(max-width:500px){.mode-btn{font-size:24px;padding:10px 20px}.mode-title{font-size:32px}}
#hosky-options-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:110000;display:none;flex-direction:column;justify-content:center;align-items:center;gap:18px;background:rgba(0,0,0,.95)}
.hosky-choice{display:flex;flex-direction:column;align-items:center;gap:8px}
.hosky-btn{font-family:'GROBOLD',sans-serif;font-size:26px;color:#206cd2;background:black;border:2px solid #206cd2;padding:12px 20px;cursor:pointer;border-radius:8px;text-transform:uppercase;min-width:260px}
.hosky-desc{color:#cccccc;font-size:14px;text-align:center;max-width:300px}
.hosky-cancel{margin-top:12px;font-size:14px;color:#fff;background:transparent;border:none;text-decoration:underline;cursor:pointer}
</style>
</head>
<body>

<div style="position:fixed;top:5px;left:5px;font-size:12px;color:#206cd2;font-family:'GROBOLD',sans-serif;z-index:120000;opacity:0.7;">v4.2.0.6.9</div>
<!-- Home button -->
<div id="home-button" title="Home" style="
    position: fixed;
    top: 25px;
    left: 5px;
    font-size: 20px;
    color: #206cd2;
    cursor: pointer;
    z-index: 120001;
    opacity: 0.8;
">
    üè†
</div>

<div id="mode-select-overlay">
  <h1 style="font-size:72px;color:#206cd2;margin-bottom:20px;text-shadow:0 0 10px #00ff00,0 0 8px #00ff00,0 0 12px #00ff00">GLABDLE</h1>
  <h2 class="mode-title">Choose Mode</h2>
  <div style="display:flex;gap:20px">
    <button class="mode-btn" id="hosky-btn" type="button">HOSKY Words</button>
    <button class="mode-btn" id="normal-btn" type="button">NORMAL Words</button>
  </div>
<!-- Quantum button BELOW the others -->
<button class="mode-btn quantum-small-btn" id="quantum-btn" type="button">
    QUANTUM HOSKY WEBSITE
</button>
</div>

<div id="hosky-options-overlay">
  <div style="text-align:center">
    <h1 style="font-size:56px;color:#206cd2;margin-bottom:6px">HOSKY MODE</h1>
    <div style="color:#cccccc;margin-bottom:14px">Choose difficulty before starting</div>
  </div>

  <div class="hosky-choice">
    <button class="hosky-btn" id="hosky-easy-btn">NOOB MODE</button>
    <div class="hosky-desc">Only pulls Hosky words that are 6 characters or less EASY</div>
  </div>

  <div class="hosky-choice">
    <button class="hosky-btn" id="hosky-hard-btn">OG MODE</button>
    <div class="hosky-desc">Pulls from the full Hosky word pool DIFFICULT</div>
  </div>

  <div class="hosky-choice">
    <button class="hosky-btn" id="hosky-gib-btn">GIBBERISH MODE</button>
    <div class="hosky-desc">Accepts any combination of letters as valid guesses DEGEN</div>
  </div>

  <button id="hosky-cancel" class="hosky-cancel">Cancel</button>
</div>

<div id="correct-word-display" style="position:fixed;top:20px;right:10px;font-size:24px;color:orange;font-family:'GROBOLD',sans-serif;z-index:10002;display:none">WORD</div>

<div id="game-wrapper">

  <h1>GLABDLE</h1>
  <div id="game-container">
    <div class="row" id="row0"></div>
    <div class="row" id="row1"></div>
    <div class="row" id="row2"></div>
    <div class="row" id="row3"></div>
    <div class="row" id="row4"></div>
    <div class="row" id="row5"></div>
  </div>
  <div id="alphabet"></div>
</div>

<input id="mobile-input" maxlength="5" />

<div id="win-gif-container"></div>
<div id="lose-gif-container"></div>

<div id="win-message">GOOD JOB IDJIOT</div>
<div id="lose-message">TRY AGAIN IDJIOT</div>

<div id="games-counter">Total games submitted: <span id="games-count">0</span></div>

<script async src="https://tenor.com/embed.js"></script>

<script>
// --- state & pools ---
let selectedMode = 'HOSKY';
let hoskyDifficulty = 'HARD';
let gibberishMode = false;
let targetWord = "HOSKY";
let wordLength = 5;

document.getElementById('home-button').addEventListener('click', () => {

    // Reset game state
    gameOver = false;
    currentRow = 0;
    currentCol = 0;

    // Clear the board
    for (let r = 0; r < 6; r++) {
        const cells = document.getElementById(`row${r}`).querySelectorAll('.cell');
        cells.forEach(c => {
            c.textContent = '';
            c.className = 'cell';
        });
    }

    // Reset alphabet colors
    document.querySelectorAll('.letter-box').forEach(box => {
        box.style.backgroundColor = 'rgba(0,0,0,0.9)';
        box.style.color = '#206cd2';
    });

    // Hide game screen
    gameWrapper.style.display = 'none';

    // Hide win/lose text
    document.getElementById('win-message').style.display = 'none';
    document.getElementById('lose-message').style.display = 'none';

    // Hide GIF containers
    document.getElementById('win-gif-container').style.display = 'none';
    document.getElementById('lose-gif-container').style.display = 'none';

    // Stop poop rain
    document.querySelectorAll('.falling-poo').forEach(el => el.remove());

    // Remove dynamic end-screen buttons
    const winButtons = document.getElementById('win-buttons-container');
    if (winButtons) winButtons.remove();

    const loseButtons = document.getElementById('lose-buttons-container');
    if (loseButtons) loseButtons.remove();

    // Close Hosky mode difficulty menu if open
    document.getElementById('hosky-options-overlay').style.display = 'none';

    // Remove blur
    setBlur(false);

    // Show mode select screen again
    document.getElementById('mode-select-overlay').style.display = 'flex';

    // Prevent word carryover
    sessionStorage.removeItem('glabble_state');

});

// QUANTUM HOSKY BUTTON ‚Üí External redirect
document.getElementById('quantum-btn').addEventListener('click', () => {
    window.location.href = "https://quantumhosky.iog.io/";

    // Hide game wrapper & messages
    gameWrapper.style.display = 'none';
    document.getElementById('win-message').style.display = 'none';
    document.getElementById('lose-message').style.display = 'none';
    document.getElementById('alphabet').style.filter = 'none';
    setBlur(false);

    // Hide Hosky mode menu if open
    document.getElementById('hosky-options-overlay').style.display = 'none';

    // Hide GIF containers & poop animations
    document.getElementById('win-gif-container').style.display = 'none';
    document.getElementById('lose-gif-container').style.display = 'none';
    document.querySelectorAll('.falling-poo').forEach(el => el.remove());

    // Remove dynamic win/lose buttons if they exist
    const winButtons = document.getElementById('win-buttons-container');
    if (winButtons) winButtons.remove();
    const loseButtons = document.getElementById('lose-buttons-container');
    if (loseButtons) loseButtons.remove();

    // Show mode selection overlay
    document.getElementById('mode-select-overlay').style.display = 'flex';
});




const hoskyPool = ["CHARLES","JKRO","JKROBAR","ALPHA","DANKSY","TBLH","HOSKY","THEBIGLEHOSKY","RADIOACTIVE","GLAB","ZERO","NOOB","DEGEN","DEGENERAL","DISCORD","CABAL","WEN","MOON","RUG","WOOF","RUGPOOL","WENWEBSITE","WENPDF","CURRYWURST","WOOSHIE","SCHMACK","BOSSKY","BIGBOSSKY", "SPAM", "RIGGED", "STAKE", "PAYDAY", "CARDANO", "RAIN", "RAFFLE", "CASHGRAB", "BIXBY", "HOSKY", "WENLAMBO", "DIMA", "DIMALIX", "TRYM", "QUANTUM", "MODS", "DEEZ", "DEEZNUTS", "VOTE", "TACO", "EGG", "WENWENWEN", "BULLISH", "BEARISH", "TAPTOOLS", "HOSKYTEN", "THOON", "MOONBOY", "DEVHOUR", "HAWAK", "ASPEN", "MALU","PSB", "QCPOL", "LIDO", "RARE", "WEED", "STOIC", "HAZEL", "BONE", "BONEPOOL", "PSYA", "WRFGS", "BAIDU", "ATHREEC", "SALT", "FARM", "PRIDE", "GOMA", "SEA", "CHEF", "DDOS", "PAMPGLABS", "UPONLY", "BULL", "BEAR", "CRYPTO", "RUIKKU", "SCOOB", "TENDIES", "SHROOMS", "NEIMO", "THUGG", "PARTGOD", "TENDIES", "PUUBAH", "COVEY", "BUSYBUSY", "PEWPS", "KDOG"  ];
const extraWords = ["HOSKY","GLABS"];
const triggerWords = ["SAYOS","VEGAS","JINXY","CERFY","GLABS"];
const winningGifs = ["4540374823853696704","24111898","24123953","10534076","7551288617603856546"];
const gameWrapper = document.getElementById('game-wrapper');

// redirects (kept)
const redirects = {
  "SAYOS":["https://en.wikipedia.org/wiki/Burbot","https://www.mazda.com/en/","https://www.youtube.com/watch?v=K1fyza5BN-0","https://www.hkmaps.hk/viewer.html","https://www.youtube.com/watch?v=YJFNdIJnrHY","https://www.spanishdict.com/translate/sayos"],
  "VEGAS":["https://x.com/HoskyDevVegas/status/1947043091216494826","https://www.dreamvacations.com/vacation/destinations/all","https://www.youtube.com/watch?v=1DUaR0zBGgQ","https://www.christinascucina.com/beans-on-toast-the-proper-british-way-recipe-by-a-brit/","https://www.urbandictionary.com/define.php?term=foo-foo%20drink"],
  "JINXY":["https://en.wikipedia.org/wiki/Flat_bean","https://www.reddit.com/r/Netherlands/comments/1ghutfw/what_are_some_crucial_traditional_dutch/","https://www.thedutchtable.com/2010/10/bitterballen-dutch-deep-fried-gravy.html"],
  "CERFY":["https://www.youtube.com/watch?v=aBquLj4kLxQ","https://www.youtube.com/watch?v=4npQAvzrND0","https://www.imdb.org"],
  "GLABS":["https://www.jpg.store/collection/hoskycashgrab?tab=items&filters=eyJmdXIiOlsiR29sZUVuIExhYnJhZG9yIl19"]
};

const profanityRedirects = [
  "https://www.reddit.com/r/Rants/comments/p1vrsr/when_people_say_keep_it_pg_do_they_mean_keep_it/",
  "https://en.wikipedia.org/wiki/Potty_mouth",
  "https://media1.tenor.com/m/atMg0UR5eNsAAAAd/aborddelimpala-sam-winchester.gif",
  "https://media1.tenor.com/m/Dj9mOVehujAAAAAC/chill-chill-out.gif",
  "https://www.ancestry.com/last-name-meaning/skustin",
  "https://www.youtube.com/watch?v=4KjxFDGFKhk",
  "https://claremontreviewofbooks.com/im-offended/"
];

// profanity check (fixed)
const profaneWords = ["fuck","shit","bitch","bastard","dick","cunt","asshole","nigger","faggot","slut","whore","cock","pussy","douche"];
function checkProfanity(word){ if(!word) return false; const low = word.toLowerCase(); return profaneWords.some(p => low.includes(p)); }

// restore persisted difficulty if present
const persistedDiff = sessionStorage.getItem('glabble_hosky_difficulty');
if(persistedDiff === 'EASY' || persistedDiff === 'HARD' || persistedDiff === 'GIBBERISH'){
  hoskyDifficulty = persistedDiff;
  gibberishMode = (persistedDiff === 'GIBBERISH');
}

// permissive dictionary check
async function isValidWord(word){
  const up = (word||'').toUpperCase();
  if(gibberishMode) return /^[A-Z]+$/.test(up);
  if(up === (targetWord||'').toUpperCase()) return true;
  if(extraWords.map(w=>w.toUpperCase()).includes(up)) return true;
  if(Array.isArray(hoskyPool) && hoskyPool.map(w=>w.toUpperCase()).includes(up)) return true;
  try {
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    return res.ok;
  } catch(e) {
    console.debug('isValidWord: dictionary failed, allowing guess', word, e);
    return true;
  }
}

// pick hosky word by difficulty
function pickHoskyWord(difficulty='HARD'){
  let pool = hoskyPool.slice();
  if(difficulty === 'EASY'){
    const filtered = pool.filter(w => String(w).length <= 6);
    if(filtered.length) pool = filtered;
  }
  if(pool.length === 0) pool = hoskyPool.slice();
  return pool[Math.floor(Math.random()*pool.length)].toUpperCase();
}

// sizing/board (kept robust)
async function adjustBoardForWordLength() {
// Force layout recalculation on mobile
  if(window.innerWidth <= 500) {
    document.body.style.minHeight = window.innerHeight + 'px';
  }  
const mi = document.getElementById('mobile-input'); 
  if(mi) mi.maxLength = wordLength;

  const wrapper = document.getElementById('game-wrapper'); 
  const container = document.getElementById('game-container'); 
  const gap = 10;
  const totalGapsH = (Math.max(1, wordLength) - 1) * gap;
  const totalGapsV = (6 - 1) * gap;

  if (!wrapper || wrapper.clientWidth < 20) {
    requestAnimationFrame(() => setTimeout(adjustBoardForWordLength, 40)); 
    return; 
  }

  try { 
    if(document.fonts && document.fonts.status !== 'loaded') {
      await document.fonts.ready; 
      await new Promise(r=>setTimeout(r,20)); 
    } 
  } catch(e){}

  const bodyStyle = getComputedStyle(document.body); 
  const bodyPadL = parseFloat(bodyStyle.paddingLeft||0); 
  const bodyPadR = parseFloat(bodyStyle.paddingRight||0);

  const measuredWrapperWidth = Math.max(160, wrapper.clientWidth || Math.floor(window.innerWidth*0.9)); 
  const viewportUsableWidth = Math.max(160, window.innerWidth - bodyPadL - bodyPadR - 32);
  const availableWidth = Math.min(measuredWrapperWidth, viewportUsableWidth);

  const titleEl = wrapper.querySelector('h1'); 
  const alphabetEl = document.getElementById('alphabet'); 
  const titleH = titleEl ? Math.ceil(titleEl.getBoundingClientRect().height) : 0; 
  const keyboardH = alphabetEl ? Math.ceil(alphabetEl.getBoundingClientRect().height) : 72;

  const verticalReserve = 40; 
  const usableHeight = Math.max(120, window.innerHeight - titleH - keyboardH - verticalReserve - (parseFloat(bodyStyle.paddingTop||0)+parseFloat(bodyStyle.paddingBottom||0)));

  const cellByWidth = Math.floor((availableWidth - totalGapsH) / Math.max(1, wordLength)); 
  const cellByHeight = Math.floor((usableHeight - totalGapsV) / 6);

  const ORIGINAL_CELL = 48; 
  const MIN_CELL = 12;

  // Pick the smallest so it fits both width and height
  let cellSize = Math.min(cellByWidth, cellByHeight, ORIGINAL_CELL); 
  if(cellSize < MIN_CELL) cellSize = MIN_CELL;

  // Extra safety: shrink if total board still exceeds viewport
  const totalBoardHeight = (cellSize * 6) + totalGapsV + titleH + keyboardH + verticalReserve;
  if(totalBoardHeight > window.innerHeight){
    const availableForCells = Math.max((window.innerHeight - titleH - keyboardH - verticalReserve - totalGapsV), MIN_CELL * 6); 
    const newCell = Math.floor(availableForCells / 6); 
    cellSize = Math.max(MIN_CELL, Math.min(cellSize, newCell)); 
  }

  const finalGridWidth = (cellSize * wordLength) + totalGapsH; 
  if(finalGridWidth > availableWidth){
    const shrinkCell = Math.floor((availableWidth - totalGapsH) / Math.max(1, wordLength)); 
    cellSize = Math.max(MIN_CELL, Math.min(cellSize, shrinkCell)); 
  }

  const fontSize = Math.min(36, Math.max(10, Math.floor(cellSize * 0.6)));

  container.style.overflowX='hidden'; 
  container.style.minWidth=''; 
  container.style.justifyContent='center';
  container.style.width = `${Math.min(finalGridWidth, availableWidth)}px`;
  container.style.gridTemplateRows = `repeat(6, ${cellSize}px)`;

  for(let r=0; r<6; r++){ 
    const row = document.getElementById(`row${r}`); 
    if(!row) continue; 
    row.style.gridTemplateColumns = `repeat(${wordLength}, ${cellSize}px)`; 
    row.style.height = `${cellSize}px`; 
    
    const existingCells = row.querySelectorAll('.cell');
    if(existingCells.length !== wordLength) {
      row.innerHTML='';
      createCells(row, r, cellSize, fontSize);
    } else {
      existingCells.forEach(cell => {
        cell.style.width = `${cellSize}px`;
        cell.style.height = `${cellSize}px`;
        cell.style.fontSize = `${fontSize}px`;
      });
    }
    row.style.justifyContent='center'; 
  }
  updateActiveCell();
}


// create cells
function createCells(row,rowIndex, cellSize=63, fontSize=36){
  for(let i=0;i<wordLength;i++){
    const cell = document.createElement('div');
    cell.classList.add('cell');
    cell.style.width = `${cellSize}px`;
    cell.style.height = `${cellSize}px`;
    cell.style.fontSize = `${fontSize}px`;
    row.appendChild(cell);
    cell.addEventListener('click', ()=>{ if(rowIndex===currentRow && !gameOver){ currentCol=i; updateActiveCell(); if(window.innerWidth<=500) document.getElementById('mobile-input').focus(); row.scrollIntoView({behavior:'smooth', block:'center'}); } });
  }
}
for(let i=0;i<6;i++) createCells(document.getElementById(`row${i}`), i);

// alphabet keyboard
const alphabetContainer = document.getElementById('alphabet');
for (let L of "ABCDEFGHIJKLMNOPQRSTUVWXYZ") {
  const box = document.createElement('div'); box.classList.add('letter-box'); box.id = `letter-${L}`; box.textContent = L; alphabetContainer.appendChild(box);
}
const enterBox = document.createElement('div'); enterBox.classList.add('letter-box','enter-box'); enterBox.id='letter-enter'; enterBox.textContent='ENTER'; alphabetContainer.appendChild(enterBox);
const backBox = document.createElement('div'); backBox.classList.add('letter-box','enter-box'); backBox.id='letter-backspace'; backBox.textContent='back'; alphabetContainer.appendChild(backBox);
document.querySelectorAll('.letter-box').forEach(box => box.addEventListener('click', () => {
  if(box.id === 'letter-enter') handleKey('Enter');
  else if(box.id === 'letter-backspace') handleKey('Backspace');
  else handleKey(box.textContent);
}));

// helpers
function updateAlphabet(letter, state) {
    const box = document.getElementById(`letter-${letter}`);
    if(!box) return;
    
    // Get current background color
    const currentBg = box.style.backgroundColor;
    
    // If already green, never change it
    if(currentBg === 'rgb(0, 255, 0)' || currentBg === '#00ff00') return;
    
    // Green = letter is in the word (yellow or blue on board)
    if(state === 'green' || state === 'yellow') {
        box.style.backgroundColor = '#00ff00';  // bright green
        box.style.color = 'black';
    }
    // Gray = letter not in word (only if not already green)
    else if(state === 'gray') {
        box.style.backgroundColor = '#555';
        box.style.color = 'black';
    }
}
function updateActiveCell(){ document.querySelectorAll('.cell').forEach(c=>c.classList.remove('active')); const cells=document.getElementById(`row${currentRow}`).querySelectorAll('.cell'); if(currentCol<0) currentCol=0; if(currentCol>=wordLength) currentCol=wordLength-1; if(currentCol<wordLength) cells[currentCol].classList.add('active'); if(window.innerWidth<=500){ setTimeout(()=>document.getElementById(`row${currentRow}`).scrollIntoView({behavior:'smooth', block:'center'}),50); } }
function setBlur(enable){ gameWrapper.style.filter = enable ? 'blur(5px)' : 'none' }
function fadeIn(el){ el.style.display='block'; requestAnimationFrame(()=>el.style.opacity='1') }
function fadeOut(el){ el.style.opacity='0'; setTimeout(()=>el.style.display='none',1000) }
function startPoopRain(count=16){ for(let i=0;i<count;i++){ const p=document.createElement('div'); p.classList.add('falling-poo'); p.textContent='üí©'; p.style.left=Math.random()*(window.innerWidth-100)+'px'; p.style.fontSize=(110+Math.random()*120)+'px'; p.style.animationDuration=(10+Math.random()*6)+'s'; document.body.appendChild(p); p.addEventListener('animationend',()=>p.remove()); } }
function startLosePoopRain(count=12){ for(let i=0;i<count;i++){ const p=document.createElement('div'); p.classList.add('falling-poo'); p.textContent='üí©'; p.style.left=Math.random()*(window.innerWidth-80)+'px'; p.style.fontSize=(60+Math.random()*80)+'px'; p.style.animationDuration=(5+Math.random()*5)+'s'; document.body.appendChild(p); p.addEventListener('animationend',()=>p.remove()); } }

// session save/load
function saveGameState(){ const state={ currentRow, currentCol, board:[], gameOver, selectedMode, hoskyDifficulty}; for(let r=0;r<6;r++){ const cells=document.getElementById(`row${r}`).querySelectorAll('.cell'); state.board.push(Array.from(cells).map(c=>({letter:c.textContent,classes:c.className}))); } const alphabetState={}; "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("").forEach(l=>{ const box=document.getElementById(`letter-${l}`); if(box) alphabetState[l]=box.style.backgroundColor; }); state.alphabet = alphabetState; sessionStorage.setItem('glabble_state', JSON.stringify(state)); sessionStorage.setItem('glabble_mode', selectedMode); sessionStorage.setItem('glabble_hosky_difficulty', hoskyDifficulty || 'HARD'); }
function loadGameState(){ const stateRaw=sessionStorage.getItem('glabble_state'); if(!stateRaw) return; const state=JSON.parse(stateRaw); if(state.selectedMode) selectedMode = state.selectedMode; else { const m=sessionStorage.getItem('glabble_mode'); if(m==='HOSKY'||m==='NORMAL') selectedMode=m; } if(state.hoskyDifficulty){ hoskyDifficulty=state.hoskyDifficulty; gibberishMode=(hoskyDifficulty==='GIBBERISH'); } else { const pd=sessionStorage.getItem('glabble_hosky_difficulty'); if(pd==='EASY'||pd==='HARD'||pd==='GIBBERISH'){ hoskyDifficulty=pd; gibberishMode=(pd==='GIBBERISH'); } } if(state.board && state.board[0] && state.board[0].length){ wordLength = state.board[0].length; adjustBoardForWordLength(); } currentRow = state.currentRow; currentCol = state.currentCol; gameOver = state.gameOver || false; for(let r=0;r<6;r++){ const cells=document.getElementById(`row${r}`).querySelectorAll('.cell'); if(!state.board[r]) continue; cells.forEach((c,i)=>{ if(state.board[r][i]){ c.textContent = state.board[r][i].letter; c.className = state.board[r][i].classes; if(!c.classList.contains('cell')) c.classList.add('cell'); } else { c.textContent=''; c.className='cell'; } }); } if(state.alphabet){ for(let l in state.alphabet){ const box=document.getElementById(`letter-${l}`); if(box) box.style.backgroundColor = state.alphabet[l]; } } updateActiveCell(); if(gameOver) mobileInput.blur(); }

// input handling
const mobileInput = document.getElementById('mobile-input');
let currentRow=0, currentCol=0, gameOver=false;
mobileInput.addEventListener('input', e=>{ const v=e.target.value.toUpperCase(); if(v.length>0){ handleKey(v[v.length-1]); mobileInput.value=''; } });

// prevent default on keydown to avoid browser interfering
document.addEventListener('keydown', e=>{ e.preventDefault(); handleKey(e.key); });

// focus on mobile
if(window.innerWidth<=500){ window.addEventListener('load', ()=>{ mobileInput.focus(); setTimeout(()=>document.getElementById(`row${currentRow}`)?.scrollIntoView({behavior:'smooth', block:'center'}),50); }); }

// counter
let totalGames = parseInt(localStorage.getItem('glabble_totalGames')||'0');
document.getElementById('games-count').textContent = totalGames;

// handleKey
async function handleKey(key){
  if(gameOver) return;
  const row = document.getElementById(`row${currentRow}`);
  if(!row) return;
  const cells = row.querySelectorAll('.cell');

  if(key==='Backspace' || key==='Delete'){
    if(cells[currentCol].textContent===""){ if(currentCol>0) currentCol--; cells[currentCol].textContent=""; } else { cells[currentCol].textContent=""; }
    updateActiveCell(); saveGameState(); return;
  }

  if(key==='Enter'){
    if(Array.from(cells).every(c=>c.textContent!=="")){
      const guess = Array.from(cells).map(c=>c.textContent).join('').toUpperCase();
      console.debug('handleKey Enter:', guess, 'row', currentRow);
      await processGuess(guess);
    } else {
      console.debug('Enter pressed but row incomplete');
    }
    return;
  }

  if(/^[a-zA-Z]$/.test(key)){
    if(currentCol < wordLength){
      cells[currentCol].textContent = key.toUpperCase();
      if(currentCol < wordLength-1) currentCol++;
      updateActiveCell();
      saveGameState();
    }
  }
}

// processGuess (defensive)
async function processGuess(guess){
  console.debug('processGuess start', guess, 'target', targetWord);
  try {
    const row = document.getElementById(`row${currentRow}`);
    const cells = row.querySelectorAll('.cell');

    if(!triggerWords.includes(guess) && !(await isValidWord(guess))){
      alert("THAT AIN'T NO REAL WERD, IDJIOT!");
      cells.forEach(c=>c.textContent='');
      currentCol = 0; updateActiveCell(); saveGameState(); return;
    }

    const targetLetters = targetWord.split('');
    const guessLetters = guess.split('');
    const letterCounts = {};
    targetLetters.forEach(l => letterCounts[l] = (letterCounts[l]||0)+1);

    const results = Array(wordLength).fill('gray');
    for(let i=0;i<wordLength;i++){ if(guessLetters[i]===targetLetters[i]){ results[i]='green'; letterCounts[guessLetters[i]]--; } }
    for(let i=0;i<wordLength;i++){ if(results[i]==='gray' && letterCounts[guessLetters[i]]>0){ results[i]='yellow'; letterCounts[guessLetters[i]]--; } }

    for(let i=0;i<wordLength;i++){
    cells[i].classList.remove('green','yellow','gray');
    cells[i].classList.add(results[i]);
    
    // For keyboard: green/yellow on board = green on keyboard
    const keyboardState = (results[i] === 'green' || results[i] === 'yellow') ? 'green' : 'gray';
    updateAlphabet(cells[i].textContent, keyboardState);
    
    cells[i].style.animation = `revealLetter 0.6s ease forwards ${i*0.15}s`;
    cells[i].addEventListener('animationend', ()=>cells[i].style.animation='', { once:true });
}

    cells.forEach(c=>c.classList.add('locked'));
    saveGameState();

    // win
    if(guess === targetWord){
  gameOver = true; 
  mobileInput.blur(); 
  saveGameState();
  setBlur(true);

// --- define once ---
function goToHoskyOptionsMenu() {
    // Hide game wrapper and messages
    gameWrapper.style.display = 'none';
    document.getElementById('win-message').style.display = 'none';
    document.getElementById('lose-message').style.display = 'none';
    document.getElementById('alphabet').style.filter = 'none';
    setBlur(false);

    // Show Hosky mode options overlay
    document.getElementById('hosky-options-overlay').style.display = 'flex';
}

  // ADD BUTTONS FIRST
  setTimeout(() => {
    addWinButtons();
}, 3000);

  // show gif
  const gifContainer = document.getElementById('win-gif-container');
  const randomId = winningGifs[Math.floor(Math.random()*winningGifs.length)];
  gifContainer.innerHTML = "";
  const embedDiv=document.createElement('div'); 
  embedDiv.className='tenor-gif-embed'; 
  embedDiv.setAttribute('data-postid', randomId); 
  embedDiv.setAttribute('data-share-method','host'); 
  embedDiv.setAttribute('data-aspect-ratio','1'); 
  embedDiv.setAttribute('data-width','100%'); 
  gifContainer.appendChild(embedDiv);
  const script=document.createElement('script'); 
  script.type='text/javascript'; script.async=true; 
  script.src='https://tenor.com/embed.js'; 
  gifContainer.appendChild(script);
  fadeIn(gifContainer); 
  startPoopRain(80);

  setTimeout(()=>{
    fadeOut(gifContainer); 
    document.getElementById('win-message').style.display='block';
  }, 4000);

  sessionStorage.setItem('glabble_restore','1');
  setTimeout(()=>{ window.location.href='https://hosky.io'; }, 8000);
  return;
}


    // lose
   if(currentRow === 5){
  gameOver = true;
  const correctDisplay = document.getElementById('correct-word-display');
  correctDisplay.textContent = targetWord.toUpperCase(); 
  correctDisplay.style.display='block';
  setBlur(true); 
  mobileInput.blur(); 
  saveGameState(); 
  
  
  // ADD BUTTONS FIRST
  setTimeout(() => {
    addLoseButtons();
}, 3000);

  startLosePoopRain(40);
  const loseGifs=["6289320449545116130","24576363","5408039","1639610178022128587","1514012758219765433"];
  const gifContainer=document.getElementById('lose-gif-container');
  const randomId=loseGifs[Math.floor(Math.random()*loseGifs.length)];
  gifContainer.innerHTML="";
  const embedDiv=document.createElement('div'); 
  embedDiv.className='tenor-gif-embed'; 
  embedDiv.setAttribute('data-postid', randomId); 
  embedDiv.setAttribute('data-share-method','host'); 
  embedDiv.setAttribute('data-aspect-ratio','1'); 
  embedDiv.setAttribute('data-width','100%'); 
  gifContainer.appendChild(embedDiv);
  const script=document.createElement('script'); 
  script.type='text/javascript'; script.async=true; 
  script.src='https://tenor.com/embed.js'; 
  gifContainer.appendChild(script);
  fadeIn(gifContainer); 
  setTimeout(()=>{
    fadeOut(gifContainer); 
    document.getElementById('lose-message').style.display='block';
  }, 4000);

  sessionStorage.setItem('glabble_restore','1');
  setTimeout(()=>{ window.location.href='https://hosky.io'; }, 8000);
  return;
}

    // profanity
    if(checkProfanity(guess)){
  currentRow++; currentCol=0; updateActiveCell(); saveGameState();
  const randomLink = profanityRedirects[Math.floor(Math.random() * profanityRedirects.length)];
  window.open(randomLink, '_blank');
  return;
}

    // trigger
    if(triggerWords.includes(guess)){
      currentRow++; currentCol=0; updateActiveCell(); saveGameState();
      const links = redirects[guess]; const randomLink = links[Math.floor(Math.random()*links.length)]; window.open(randomLink, '_blank'); return;
    }

    // next row
    currentRow++; currentCol=0; updateActiveCell(); saveGameState();
    console.debug('advanced to row', currentRow);
  } catch(err){
    console.error('processGuess error', err);
    alert('Error processing guess ‚Äî see console');
  }
}

// restore behavior on load (only if back_forward or restore flag)
window.addEventListener('load', () => {
  const saved = sessionStorage.getItem('glabble_state');
  if (!saved) return;

  const navType = (performance.getEntriesByType("navigation")[0] || {}).type || '';
  const restoreFlag = sessionStorage.getItem('glabble_restore');
  if (navType !== 'back_forward' && restoreFlag !== '1') return;

  sessionStorage.removeItem('glabble_restore');

  // Hide mode selection overlay and show game wrapper
  document.getElementById('mode-select-overlay').style.display = 'none';
  gameWrapper.style.display = 'flex';

  // Load the game state first
  loadGameState();

  // Parse state to check win/lose
  const state = JSON.parse(saved);
  const lastRow = state.board && state.board[state.currentRow > 0 ? state.currentRow - 1 : 0];
  const won = lastRow && lastRow.every(c => c.classes.includes('green'));

  // NOW hide all the UI elements
  document.getElementById('win-message').style.display = 'none';
  document.getElementById('lose-message').style.display = 'none';
  document.getElementById('correct-word-display').style.display = 'none';
  document.getElementById('win-gif-container').style.display = 'none';
  document.getElementById('win-gif-container').style.opacity = 0;
  document.getElementById('lose-gif-container').style.display = 'none';
  document.getElementById('lose-gif-container').style.opacity = 0;
  
  document.querySelectorAll('.falling-poo').forEach(el => el.remove());
  setBlur(false);
  mobileInput.blur();

  // Adjust board
  requestAnimationFrame(() => setTimeout(adjustBoardForWordLength, 20));

  // Add buttons - use requestAnimationFrame to ensure DOM is ready
  requestAnimationFrame(() => {
    setTimeout(() => {
      if (won) {
        addWinButtons();
      } else if (state.gameOver) {
        addLoseButtons();
      }
    }, window.innerWidth <= 500 ? 600 : 200);
  });
});


// debounced resize
function debounce(fn, wait=120){ let t; return function(...a){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait); }; }
const debouncedAdjust = debounce(()=>requestAnimationFrame(()=>adjustBoardForWordLength()),120);
window.addEventListener('resize', debouncedAdjust);
window.addEventListener('orientationchange', debouncedAdjust);
window.addEventListener('pageshow', debouncedAdjust);

// normal mode handler (left as-is)
document.getElementById('normal-btn').addEventListener('click', async ()=>{
  selectedMode='NORMAL'; gibberishMode=false; sessionStorage.setItem('glabble_mode','NORMAL'); sessionStorage.setItem('glabble_hosky_difficulty', hoskyDifficulty||'HARD'); sessionStorage.removeItem('glabble_restore');
  wordLength=5; document.getElementById('mode-select-overlay').style.display='none'; gameWrapper.style.display='flex'; requestAnimationFrame(()=>setTimeout(adjustBoardForWordLength,20));
  try{ const res=await fetch('https://random-word-api.vercel.app/api?words=1&length=5'); const data=await res.json(); targetWord=data[0].toUpperCase(); }catch(e){ console.error('normal fetch failed',e); targetWord='APPLE'; }
});

// delegated hosky-options overlay click handler (robust)
document.getElementById('hosky-btn').addEventListener('click', ()=>{
  document.getElementById('mode-select-overlay').style.display='none';
  document.getElementById('hosky-options-overlay').style.display='flex';
});

// Delegate clicks on the overlay so listeners always work regardless of timing
document.getElementById('hosky-options-overlay').addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button');
  if(!btn) return;
  const id = btn.id;
  if(id === 'hosky-cancel'){
    document.getElementById('hosky-options-overlay').style.display='none';
    document.getElementById('mode-select-overlay').style.display='flex';
    return;
  }
  if(id === 'hosky-easy-btn' || id === 'hosky-hard-btn' || id === 'hosky-gib-btn'){
    if(id === 'hosky-easy-btn'){ hoskyDifficulty = 'EASY'; gibberishMode = false; }
    else if(id === 'hosky-hard-btn'){ hoskyDifficulty = 'HARD'; gibberishMode = false; }
    else { hoskyDifficulty = 'GIBBERISH'; gibberishMode = true; }
    sessionStorage.setItem('glabble_hosky_difficulty', hoskyDifficulty);
    // start game
    selectedMode = 'HOSKY';
    sessionStorage.setItem('glabble_mode', selectedMode);
    sessionStorage.removeItem('glabble_restore');
    targetWord = pickHoskyWord(hoskyDifficulty);
    wordLength = targetWord.length;
    document.getElementById('hosky-options-overlay').style.display='none';
    gameWrapper.style.display='flex';
    requestAnimationFrame(()=>setTimeout(adjustBoardForWordLength,20));
    saveGameState();
  }
});

// lose/win buttons (kept same as working implementation)
function addLoseButtons(){ /* implementation identical to prior working version - omitted here for brevity but present in the file */ 
  const existing=document.getElementById('lose-buttons-container'); if(existing) existing.remove(); document.getElementById('alphabet').style.filter='blur(5px)'
  const container=document.createElement('div'); container.id='lose-buttons-container'; container.style.position='fixed'; container.style.bottom='120px'; container.style.left='50%'; container.style.transform='translateX(-50%)'; container.style.display='flex'; container.style.flexDirection='row'; container.style.justifyContent='center'; container.style.alignItems='center'; container.style.gap='15px'; container.style.flexWrap='wrap'; container.style.maxWidth='90%'; container.style.zIndex='10005';
  function createButton(text,onClick){ const btn=document.createElement('button'); btn.type='button'; btn.textContent=text; btn.style.fontFamily='GROBOLD, sans-serif'; btn.style.fontSize='20px'; btn.style.padding='14px 28px'; btn.style.cursor='pointer'; btn.style.borderRadius='6px'; btn.style.border='2px solid #206cd2'; btn.style.backgroundColor='#ffa500'; btn.style.color='black'; btn.style.minWidth='180px'; btn.style.maxWidth='220px'; btn.style.flex='1 1 auto'; btn.addEventListener('mouseover',()=>{btn.style.backgroundColor='#206cd2';btn.style.color='black'}); btn.addEventListener('mouseout',()=>{btn.style.backgroundColor='#ffa500';btn.style.color='black'}); btn.addEventListener('click', onClick); return btn; }
  const defaultModeForLabel=(selectedMode==='HOSKY'||selectedMode==='NORMAL')?selectedMode:(sessionStorage.getItem('glabble_mode')==='HOSKY'||sessionStorage.getItem('glabble_mode')==='NORMAL')?sessionStorage.getItem('glabble_mode'):'HOSKY';
  const newBtnLabel=(defaultModeForLabel==='HOSKY')?'NEW GAME':'NEW WORD';
  const newWordBtn=createButton(newBtnLabel,()=>{
    container.remove();
    currentRow=0; currentCol=0; gameOver=false;
    document.getElementById('lose-message').style.display='none'; document.getElementById('correct-word-display').style.display='none'; setBlur(false); document.getElementById('alphabet').style.filter='none'
    for(let r=0;r<6;r++){ const cells=document.getElementById(`row${r}`).querySelectorAll('.cell'); cells.forEach(c=>{c.textContent='';c.className='cell'}); }
    "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("").forEach(l=>{ const box=document.getElementById(`letter-${l}`); if(box){ box.style.backgroundColor=''; box.style.color='#206cd2'; }});
    const persisted=sessionStorage.getItem('glabble_mode');
    const modeToUse=(selectedMode==='HOSKY'||selectedMode==='NORMAL')?selectedMode:(persisted==='HOSKY'||persisted==='NORMAL')?persisted:'HOSKY';
    sessionStorage.setItem('glabble_mode', modeToUse); selectedMode = modeToUse;
    if(modeToUse === 'NORMAL'){
      gibberishMode = false;
      fetch('https://random-word-api.vercel.app/api?words=1&length=5').then(res=>res.json()).then(data=>{ targetWord=data[0].toUpperCase(); wordLength=5; adjustBoardForWordLength(); saveGameState(); }).catch(()=>{ targetWord='APPLE'; wordLength=5; adjustBoardForWordLength(); saveGameState(); });
    } else {
      const persistedDiff = sessionStorage.getItem('glabble_hosky_difficulty') || hoskyDifficulty || 'HARD';
      hoskyDifficulty = persistedDiff; gibberishMode = (hoskyDifficulty==='GIBBERISH');
      targetWord = pickHoskyWord(hoskyDifficulty); wordLength = targetWord.length; adjustBoardForWordLength(); saveGameState();
    }
    if(window.innerWidth<=500){ mobileInput.focus(); setTimeout(()=>document.getElementById(`row${currentRow}`)?.scrollIntoView({behavior:'smooth', block:'center'}),50); }
  });
  const pampBtn=createButton('PAMP GLABS', ()=>{ window.open("https://www.jpg.store/collection/hoskycashgrab?tab=items&filters=eyJmdXIiOlsiR29sZUVuIExhYnJhZG9yIl19",'_blank'); });
  container.appendChild(newWordBtn); container.appendChild(pampBtn); document.body.appendChild(container);
}

function addWinButtons(){ const existing=document.getElementById('win-buttons-container'); if(existing) existing.remove(); document.getElementById('alphabet').style.filter='blur(5px)'; const container=document.createElement('div'); container.id='win-buttons-container'; container.style.position='fixed'; container.style.bottom='120px'; container.style.left='50%'; container.style.transform='translateX(-50%)'; container.style.display='flex'; container.style.justifyContent='center'; container.style.alignItems='center'; container.style.gap='20px'; container.style.zIndex='10005'; container.style.flexWrap='wrap';
  function createButton(text,onClick){ const btn=document.createElement('button'); btn.textContent=text; btn.style.fontFamily='GROBOLD, sans-serif'; btn.style.fontSize='20px'; btn.style.padding='14px 28px'; btn.style.cursor='pointer'; btn.style.borderRadius='6px'; btn.style.border='2px solid #206cd2'; btn.style.backgroundColor='#ff7f00'; btn.style.color='black'; btn.style.transition='all .2s ease'; btn.addEventListener('mouseover',()=>{btn.style.backgroundColor='#206cd2';btn.style.color='black';btn.style.transform='scale(1.1)';btn.style.boxShadow='0 0 15px #206cd2'}); btn.addEventListener('mouseout',()=>{btn.style.backgroundColor='#ff7f00';btn.style.color='black';btn.style.transform='scale(1)';btn.style.boxShadow='none'}); btn.addEventListener('click',onClick); return btn; }
  const newGameBtn = createButton('NEW GAME', () => {
    container.remove();
    currentRow=0; currentCol=0; gameOver=false;
    document.getElementById('win-message').style.display='none';
    document.getElementById('lose-message').style.display='none';
    document.getElementById('correct-word-display').style.display='none';
    setBlur(false);
    document.getElementById('alphabet').style.filter='none';
    
    // Clear board
    for(let r=0;r<6;r++){
        const cells=document.getElementById(`row${r}`).querySelectorAll('.cell');
        cells.forEach(c=>{c.textContent='';c.className='cell'});
    }
    
    // Reset keyboard colors
    "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("").forEach(l=>{
        const box=document.getElementById(`letter-${l}`);
        if(box){
            box.style.backgroundColor='rgba(0,0,0,0.9)';
            box.style.color='#206cd2';
        }
    });
    
    // Start new game in current mode
    const modeToUse = selectedMode || sessionStorage.getItem('glabble_mode') || 'HOSKY';
    if(modeToUse === 'NORMAL'){
        gibberishMode = false;
        fetch('https://random-word-api.vercel.app/api?words=1&length=5')
            .then(res=>res.json())
            .then(data=>{
                targetWord=data[0].toUpperCase();
                wordLength=5;
                adjustBoardForWordLength();
                saveGameState();
            })
            .catch(()=>{
                targetWord='APPLE';
                wordLength=5;
                adjustBoardForWordLength();
                saveGameState();
            });
    } else {
        const persistedDiff = sessionStorage.getItem('glabble_hosky_difficulty') || hoskyDifficulty || 'HARD';
        hoskyDifficulty = persistedDiff;
        gibberishMode = (hoskyDifficulty==='GIBBERISH');
        targetWord = pickHoskyWord(hoskyDifficulty);
        wordLength = targetWord.length;
        adjustBoardForWordLength();
        saveGameState();
    }
    
    if(window.innerWidth<=500){
        mobileInput.focus();
        setTimeout(()=>document.getElementById(`row${currentRow}`)?.scrollIntoView({behavior:'smooth', block:'center'}),50);
    }
});

  const pampGlabsBtn=createButton('PAMP GLABS', ()=>{ window.open("https://www.jpg.store/collection/hoskycashgrab?tab=items&filters=eyJmdXIiOlsiR29sZUVuIExhYnJhZG9yIl19",'_blank'); });
  container.appendChild(newGameBtn); container.appendChild(pampGlabsBtn); document.body.appendChild(container);
}

// if restored win state, show win buttons
if(gameOver && document.getElementById('win-message').style.display==='block'){ addWinButtons(); }

// --- ensure buttons exist before attaching listeners ---
window.addEventListener('DOMContentLoaded', () => {

  // NORMAL button
  document.getElementById('normal-btn').addEventListener('click', async ()=>{
    selectedMode='NORMAL';
    gibberishMode=false;
    sessionStorage.setItem('glabble_mode','NORMAL');
    sessionStorage.setItem('glabble_hosky_difficulty', hoskyDifficulty||'HARD');
    sessionStorage.removeItem('glabble_restore');
    wordLength=5;
    document.getElementById('mode-select-overlay').style.display='none';
    gameWrapper.style.display='flex';
    requestAnimationFrame(()=>setTimeout(adjustBoardForWordLength,20));
    try {
      const res=await fetch('https://random-word-api.vercel.app/api?words=1&length=5');
      const data=await res.json();
      targetWord=data[0].toUpperCase();
    } catch(e) {
      console.error('normal fetch failed', e);
      targetWord='APPLE';
    }
  });

  // HOSKY button
  document.getElementById('hosky-btn').addEventListener('click', ()=>{
    document.getElementById('mode-select-overlay').style.display='none';
    document.getElementById('hosky-options-overlay').style.display='flex';
  });

  // HOSKY options overlay
  document.getElementById('hosky-options-overlay').addEventListener('click', (ev)=>{
    const btn = ev.target.closest('button');
    if(!btn) return;
    const id = btn.id;

    if(id === 'hosky-cancel'){
      document.getElementById('hosky-options-overlay').style.display='none';
      document.getElementById('mode-select-overlay').style.display='flex';
      return;
    }

    if(id === 'hosky-easy-btn' || id === 'hosky-hard-btn' || id === 'hosky-gib-btn'){
      if(id === 'hosky-easy-btn'){ hoskyDifficulty = 'EASY'; gibberishMode = false; }
      else if(id === 'hosky-hard-btn'){ hoskyDifficulty = 'HARD'; gibberishMode = false; }
      else { hoskyDifficulty = 'GIBBERISH'; gibberishMode = true; }

      sessionStorage.setItem('glabble_hosky_difficulty', hoskyDifficulty);

      // start game
      selectedMode = 'HOSKY';
      sessionStorage.setItem('glabble_mode', selectedMode);
      sessionStorage.removeItem('glabble_restore');
      targetWord = pickHoskyWord(hoskyDifficulty);
      wordLength = targetWord.length;

      document.getElementById('hosky-options-overlay').style.display='none';
      gameWrapper.style.display='flex';
      requestAnimationFrame(()=>setTimeout(adjustBoardForWordLength,20));
      saveGameState();
    }
  });

});
// Prevent zoom on double-tap
let lastTouchEnd = 0;
document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
        e.preventDefault();
    }
    lastTouchEnd = now;
}, false);

// Handle orientation changes more robustly
let resizeTimer;
window.addEventListener('orientationchange', () => {
    clearTimeout(resizeTimer);
    document.body.style.minHeight = window.innerHeight + 'px';
    resizeTimer = setTimeout(() => {
        adjustBoardForWordLength();
    }, 200);
});

// Prevent overscroll/bounce on iOS
document.addEventListener('touchmove', (e) => {
    if (e.target.closest('#game-container')) {
        // Allow scrolling within game container
        return;
    }
    e.preventDefault();
}, { passive: false });

</script>
</body>
</html>
